# Tema 5: MVC y Bases de Datos NoSQL con MongoDB

## Ãndice

1. [PatrÃ³n MVC para APIs](#1-patrÃ³n-mvc-para-apis)
2. [Estructura de Proyecto Profesional](#2-estructura-de-proyecto-profesional)
3. [MongoDB y MongoDB Atlas](#3-mongodb-y-mongodb-atlas)
4. [Mongoose 8.x](#4-mongoose-8x)
5. [ImplementaciÃ³n del MVC](#5-implementaciÃ³n-del-mvc)
6. [CRUD con MongoDB](#6-crud-con-mongodb)
7. [Relaciones entre Documentos](#7-relaciones-entre-documentos)
8. [Subida de Archivos con Multer](#8-subida-de-archivos-con-multer)
9. [Middleware de Errores](#9-middleware-de-errores)
10. [ValidaciÃ³n de ObjectId](#10-validaciÃ³n-de-objectid)

---

## 1. PatrÃ³n MVC para APIs

### 1.1 Â¿QuÃ© es MVC?

El patrÃ³n **Model-View-Controller (MVC)** es una arquitectura que separa la aplicaciÃ³n en tres componentes con responsabilidades bien definidas:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CLIENTE                             â”‚
â”‚                     (Navegador / App)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ HTTP Request
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ROUTES                              â”‚
â”‚                (Enrutamiento de peticiones)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      CONTROLLER                             â”‚
â”‚            (LÃ³gica de negocio y coordinaciÃ³n)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                                 â”‚
            â–¼                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        MODEL          â”‚       â”‚           VIEW              â”‚
â”‚  (Datos y esquemas)   â”‚       â”‚    (Respuesta JSON/HTML)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       DATABASE        â”‚
â”‚       (MongoDB)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 AdaptaciÃ³n para APIs REST

En APIs REST, el MVC se adapta asÃ­:

| Componente | Responsabilidad | Ejemplo |
|------------|-----------------|---------|
| **Model** | Estructura de datos, validaciÃ³n, interacciÃ³n con BD | Schemas de Mongoose |
| **View** | Respuesta al cliente | JSON (`res.json()`) |
| **Controller** | LÃ³gica de negocio, coordinaciÃ³n | Funciones que procesan requests |
| **Routes** | Mapeo URL â†’ Controller | `router.get('/users', getUsers)` |

### 1.3 Ventajas del MVC

- **SeparaciÃ³n de responsabilidades**: Cada componente tiene una funciÃ³n clara
- **Mantenibilidad**: FÃ¡cil de modificar partes especÃ­ficas
- **Testabilidad**: Componentes probables de forma aislada
- **Escalabilidad**: Facilita el crecimiento del proyecto
- **ReutilizaciÃ³n**: CÃ³digo reutilizable entre endpoints

---

## 2. Estructura de Proyecto Profesional

### 2.1 Estructura Recomendada

```
proyecto/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app.js                    # ConfiguraciÃ³n de Express
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â””â”€â”€ db.js                 # ConexiÃ³n a MongoDB
â”‚   â”œâ”€â”€ controllers/
â”‚   â”‚   â”œâ”€â”€ users.controller.js
â”‚   â”‚   â”œâ”€â”€ tracks.controller.js
â”‚   â”‚   â””â”€â”€ storage.controller.js
â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â”œâ”€â”€ error.middleware.js
â”‚   â”‚   â””â”€â”€ validate.middleware.js
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ user.model.js
â”‚   â”‚   â”œâ”€â”€ track.model.js
â”‚   â”‚   â””â”€â”€ storage.model.js
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”œâ”€â”€ index.js              # Agregador de rutas
â”‚   â”‚   â”œâ”€â”€ users.routes.js
â”‚   â”‚   â”œâ”€â”€ tracks.routes.js
â”‚   â”‚   â””â”€â”€ storage.routes.js
â”‚   â”œâ”€â”€ schemas/
â”‚   â”‚   â”œâ”€â”€ user.schema.js        # ValidaciÃ³n con Zod
â”‚   â”‚   â””â”€â”€ track.schema.js
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ handleError.js
â”‚       â””â”€â”€ handleStorage.js
â”œâ”€â”€ storage/                       # Archivos subidos
â”œâ”€â”€ .env                          # Variables de entorno
â”œâ”€â”€ .env.example
â”œâ”€â”€ .gitignore
â”œâ”€â”€ package.json
â””â”€â”€ README.md
```

### 2.2 Convenciones de Nomenclatura

| Tipo | ConvenciÃ³n | Ejemplo |
|------|------------|---------|
| Archivos | kebab-case o camelCase con sufijo | `users-admin.controller.js` |
| Clases/Modelos | PascalCase | `User`, `Track` |
| Funciones/Variables | camelCase | `getUsers`, `createItem` |
| Constantes | UPPER_SNAKE_CASE | `DB_URI`, `PORT` |

---

## 3. MongoDB y MongoDB Atlas

### 3.1 Â¿QuÃ© es MongoDB?

MongoDB es una base de datos **NoSQL** orientada a documentos. Almacena datos en documentos JSON flexibles (tÃ©cnicamente BSON), no en tablas rÃ­gidas.

**Comparativa SQL vs MongoDB:**

| SQL (Relacional) | MongoDB (NoSQL) |
|------------------|-----------------|
| Base de datos | Base de datos |
| Tabla | ColecciÃ³n |
| Fila | Documento |
| Columna | Campo |
| JOIN | Embedding / Referencias |
| Schema fijo | Schema flexible |

### 3.2 Documento de Ejemplo

```json
{
  "_id": "507f1f77bcf86cd799439011",
  "title": "JavaScript Avanzado",
  "artist": {
    "name": "Juan PÃ©rez",
    "email": "juan@ejemplo.com"
  },
  "duration": 180,
  "genres": ["programming", "web"],
  "plays": 15000,
  "createdAt": "2025-01-15T10:30:00Z"
}
```

### 3.3 Configurar MongoDB Atlas

MongoDB Atlas es el servicio cloud oficial de MongoDB. Ofrece un tier gratuito perfecto para desarrollo.

**Pasos para configurar:**

1. **Crear cuenta**: [mongodb.com/atlas](https://www.mongodb.com/atlas)

2. **Crear organizaciÃ³n y proyecto**

3. **Crear cluster**:
   - Seleccionar **M0 Sandbox** (gratuito)
   - Elegir proveedor (AWS, GCP, Azure) y regiÃ³n cercana

4. **Configurar acceso**:
   - **Database Access**: Crear usuario con contraseÃ±a
   - **Network Access**: Agregar IP `0.0.0.0/0` (cualquier IP, solo desarrollo)

5. **Obtener URI de conexiÃ³n**:
   - Click en "Connect" â†’ "Connect your application"
   - Copiar el connection string:

```
mongodb+srv://<usuario>:<password>@cluster0.xxxxx.mongodb.net/<database>?retryWrites=true&w=majority
```

### 3.4 Variables de Entorno

Con Node.js 22+ usamos `--env-file` nativo:

```env
# .env
PORT=3000
PUBLIC_URL=http://localhost:3000
DB_URI=mongodb+srv://usuario:password@cluster0.xxxxx.mongodb.net/midb?retryWrites=true&w=majority
```

```json
// package.json
{
  "scripts": {
    "dev": "node --watch --env-file=.env src/app.js",
    "start": "node --env-file=.env src/app.js"
  }
}
```

> ğŸ’¡ Ya no necesitas el paquete `dotenv`. Node.js 20.6+ lo soporta nativamente.

---

## 4. Mongoose 8.x

Mongoose es un ODM (Object Document Mapper) que proporciona una capa de abstracciÃ³n elegante sobre MongoDB.

### 4.1 InstalaciÃ³n

```bash
npm install mongoose
```

### 4.2 ConexiÃ³n a MongoDB

> ğŸ“‚ **CÃ³digo de ejemplo**: [`codigo/T5/src/config/db.js`](../codigo/T5/src/config/db.js)

```javascript
// src/config/db.js
import mongoose from 'mongoose';

const dbConnect = async () => {
  const DB_URI = process.env.DB_URI;
  
  if (!DB_URI) {
    console.error('âŒ DB_URI no estÃ¡ definida en .env');
    process.exit(1);
  }
  
  try {
    await mongoose.connect(DB_URI);
    console.log('âœ… Conectado a MongoDB');
  } catch (error) {
    console.error('âŒ Error conectando a MongoDB:', error.message);
    process.exit(1);
  }
};

// Eventos de conexiÃ³n
mongoose.connection.on('disconnected', () => {
  console.warn('âš ï¸ Desconectado de MongoDB');
});

// Cerrar conexiÃ³n al terminar la app
process.on('SIGINT', async () => {
  await mongoose.connection.close();
  console.log('ğŸ”Œ ConexiÃ³n a MongoDB cerrada');
  process.exit(0);
});

export default dbConnect;
```

### 4.3 Definir Schemas

> ğŸ“‚ **CÃ³digo de ejemplo**: [`codigo/T5/src/models/user.model.js`](../codigo/T5/src/models/user.model.js) y [`codigo/T5/src/models/track.model.js`](../codigo/T5/src/models/track.model.js)

Un **Schema** define la estructura de los documentos:

```javascript
// src/models/user.model.js
import mongoose from 'mongoose';

const userSchema = new mongoose.Schema(
  {
    name: {
      type: String,
      required: [true, 'El nombre es requerido'],
      trim: true,
      minlength: [2, 'MÃ­nimo 2 caracteres'],
      maxlength: [100, 'MÃ¡ximo 100 caracteres']
    },
    email: {
      type: String,
      required: [true, 'El email es requerido'],
      unique: true,
      lowercase: true,
      trim: true,
      match: [/^\S+@\S+\.\S+$/, 'Email no vÃ¡lido']
    },
    password: {
      type: String,
      required: [true, 'La contraseÃ±a es requerida'],
      minlength: 8,
      select: false  // No incluir en consultas por defecto
    },
    role: {
      type: String,
      enum: {
        values: ['user', 'admin'],
        message: '{VALUE} no es un rol vÃ¡lido'
      },
      default: 'user'
    },
    avatar: {
      type: String,
      default: null
    },
    isActive: {
      type: Boolean,
      default: true
    }
  },
  {
    timestamps: true,   // AÃ±ade createdAt y updatedAt
    versionKey: false   // Elimina __v
  }
);

// Ãndices para mejorar rendimiento
userSchema.index({ email: 1 });
userSchema.index({ role: 1, isActive: 1 });

// Ocultar password al convertir a JSON
userSchema.methods.toJSON = function() {
  const user = this.toObject();
  delete user.password;
  return user;
};

const User = mongoose.model('User', userSchema);

export default User;
```

### 4.4 Tipos de Datos en Mongoose

| Tipo | DescripciÃ³n | Ejemplo |
|------|-------------|---------|
| `String` | Cadena de texto | `"Hola mundo"` |
| `Number` | NÃºmero | `42`, `3.14` |
| `Boolean` | Verdadero/Falso | `true`, `false` |
| `Date` | Fecha | `new Date()` |
| `ObjectId` | ID de MongoDB | Referencias |
| `Array` | Lista de valores | `["a", "b"]` |
| `Mixed` | Cualquier tipo | `Schema.Types.Mixed` |
| `Buffer` | Datos binarios | Archivos |

### 4.5 Validadores Incorporados

```javascript
const trackSchema = new mongoose.Schema({
  title: {
    type: String,
    required: true,           // Obligatorio
    trim: true,               // Eliminar espacios
    minlength: 3,             // MÃ­nimo caracteres
    maxlength: 200            // MÃ¡ximo caracteres
  },
  duration: {
    type: Number,
    required: true,
    min: [1, 'MÃ­nimo 1 segundo'],
    max: [36000, 'MÃ¡ximo 10 horas']
  },
  genres: {
    type: [String],
    validate: {
      validator: (v) => v.length > 0,
      message: 'Debe tener al menos un gÃ©nero'
    }
  },
  releaseDate: {
    type: Date,
    default: Date.now
  }
});
```

---

## 5. ImplementaciÃ³n del MVC

> ğŸ“‚ **CÃ³digo de ejemplo**: [`codigo/T5/src/app.js`](../codigo/T5/src/app.js), [`codigo/T5/src/routes/`](../codigo/T5/src/routes/) y [`codigo/T5/src/controllers/`](../codigo/T5/src/controllers/)

### 5.1 AplicaciÃ³n Principal

```javascript
// src/app.js
import express from 'express';
import cors from 'cors';
import dbConnect from './config/db.js';
import routes from './routes/index.js';
import { errorHandler, notFound } from './middleware/error.middleware.js';

const app = express();

// Middleware globales
app.use(cors());
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// Archivos estÃ¡ticos
app.use('/uploads', express.static('storage'));

// Health check
app.get('/health', (req, res) => {
  res.json({ 
    status: 'ok', 
    timestamp: new Date().toISOString() 
  });
});

// Rutas de la API
app.use('/api', routes);

// Manejo de errores
app.use(notFound);
app.use(errorHandler);

// Iniciar servidor
const PORT = process.env.PORT || 3000;

const startServer = async () => {
  await dbConnect();
  app.listen(PORT, () => {
    console.log(`ğŸš€ Servidor en http://localhost:${PORT}`);
  });
};

startServer();
```

### 5.2 Carga DinÃ¡mica de Rutas

```javascript
// src/routes/index.js
import { Router } from 'express';
import { readdirSync } from 'node:fs';
import { join } from 'node:path';

const router = Router();

// Node.js 20.11+ - forma moderna de obtener __dirname
const __dirname = import.meta.dirname;

// Cargar automÃ¡ticamente archivos *.routes.js
const routeFiles = readdirSync(__dirname).filter(
  (file) => file.endsWith('.routes.js')
);

for (const file of routeFiles) {
  const routeName = file.replace('.routes.js', '');
  const routeModule = await import(join(__dirname, file));
  router.use(`/${routeName}`, routeModule.default);
  console.log(`ğŸ“ Ruta cargada: /api/${routeName}`);
}

export default router;
```

### 5.3 DefiniciÃ³n de Rutas

```javascript
// src/routes/users.routes.js
import { Router } from 'express';
import {
  getUsers,
  getUser,
  createUser,
  updateUser,
  deleteUser
} from '../controllers/users.controller.js';
import { validate, validateObjectId } from '../middleware/validate.middleware.js';
import { createUserSchema, updateUserSchema } from '../schemas/user.schema.js';

const router = Router();

router.get('/', getUsers);
router.get('/:id', validateObjectId(), getUser);
router.post('/', validate(createUserSchema), createUser);
router.put('/:id', validate(updateUserSchema), updateUser);
router.delete('/:id', validateObjectId(), deleteUser);

export default router;
```

### 5.4 Controladores

```javascript
// src/controllers/users.controller.js
import User from '../models/user.model.js';
import { handleHttpError } from '../utils/handleError.js';

// GET /api/users
export const getUsers = async (req, res) => {
  const { page = 1, limit = 10, role, isActive } = req.query;
  
  // Filtro dinÃ¡mico
  const filter = {};
  if (role) filter.role = role;
  if (isActive !== undefined) filter.isActive = isActive === 'true';
  
  const skip = (Number(page) - 1) * Number(limit);
  
  const [users, total] = await Promise.all([
    User.find(filter)
      .skip(skip)
      .limit(Number(limit))
      .sort({ createdAt: -1 }),
    User.countDocuments(filter)
  ]);
  
  res.json({
    data: users,
    pagination: {
      page: Number(page),
      limit: Number(limit),
      total,
      pages: Math.ceil(total / Number(limit))
    }
  });
};

// GET /api/users/:id
export const getUser = async (req, res) => {
  const user = await User.findById(req.params.id);
  
  if (!user) {
    return handleHttpError(res, 'Usuario no encontrado', 404);
  }
  
  res.json({ data: user });
};

// POST /api/users
export const createUser = async (req, res) => {
  const user = await User.create(req.body);
  res.status(201).json({ data: user });
};

// PUT /api/users/:id
export const updateUser = async (req, res) => {
  const user = await User.findByIdAndUpdate(
    req.params.id,
    req.body,
    { new: true, runValidators: true }
  );
  
  if (!user) {
    return handleHttpError(res, 'Usuario no encontrado', 404);
  }
  
  res.json({ data: user });
};

// DELETE /api/users/:id
export const deleteUser = async (req, res) => {
  const user = await User.findByIdAndDelete(req.params.id);
  
  if (!user) {
    return handleHttpError(res, 'Usuario no encontrado', 404);
  }
  
  res.status(204).send();
};
```

---

## 6. CRUD con MongoDB

### 6.1 Operaciones BÃ¡sicas

```javascript
// CREATE
const user = await User.create({ name: 'Juan', email: 'juan@mail.com' });
// o
const user = new User({ name: 'Juan', email: 'juan@mail.com' });
await user.save();

// READ
const users = await User.find();                          // Todos
const users = await User.find({ role: 'admin' });         // Con filtro
const user = await User.findById(id);                     // Por ID
const user = await User.findOne({ email: 'juan@mail.com' }); // Uno solo

// UPDATE
const user = await User.findByIdAndUpdate(id, { name: 'Juan PÃ©rez' }, { new: true });
const result = await User.updateMany({ role: 'user' }, { isActive: false });

// DELETE
const user = await User.findByIdAndDelete(id);
const result = await User.deleteMany({ isActive: false });
```

### 6.2 Consultas Avanzadas

```javascript
// SelecciÃ³n de campos
const users = await User.find().select('name email -_id');

// Ordenamiento
const users = await User.find().sort({ createdAt: -1 }); // DESC
const users = await User.find().sort('name');            // ASC

// PaginaciÃ³n
const page = 2;
const limit = 10;
const users = await User.find()
  .skip((page - 1) * limit)
  .limit(limit);

// Operadores de comparaciÃ³n
const users = await User.find({
  age: { $gte: 18, $lte: 65 },           // >= 18 AND <= 65
  role: { $in: ['user', 'moderator'] },   // IN array
  name: { $regex: /^J/i }                 // Regex
});

// Operadores lÃ³gicos
const users = await User.find({
  $or: [
    { role: 'admin' },
    { isActive: true }
  ]
});

// Contar
const count = await User.countDocuments({ isActive: true });

// Verificar existencia
const exists = await User.exists({ email: 'juan@mail.com' });
```

### 6.3 OptimizaciÃ³n con lean()

Por defecto, Mongoose retorna documentos con mÃ©todos y getters. Para consultas de solo lectura, `lean()` mejora significativamente el rendimiento:

```javascript
// Sin lean() - retorna documento Mongoose completo
const users = await User.find();
// users[0] tiene mÃ©todos como .save(), .toJSON(), etc.

// Con lean() - retorna objetos JavaScript planos
const users = await User.find().lean();
// ~5x mÃ¡s rÃ¡pido, usa menos memoria
// Ideal para APIs que solo envÃ­an JSON

// Combinar con otras operaciones
const users = await User.find({ isActive: true })
  .select('name email')
  .sort({ createdAt: -1 })
  .limit(10)
  .lean();
```

**CuÃ¡ndo usar `lean()`:**
- âœ… Endpoints GET que solo retornan datos
- âœ… Listados y bÃºsquedas
- âŒ Cuando necesitas modificar y guardar el documento
- âŒ Cuando necesitas virtuals o mÃ©todos del modelo

---

## 7. Relaciones entre Documentos

MongoDB ofrece dos estrategias para relacionar datos:

### 7.1 Embedding (Documentos embebidos)

Incluir documentos dentro de otros. Ideal para datos que siempre se leen juntos.

```javascript
const trackSchema = new mongoose.Schema({
  title: String,
  duration: Number,
  // Artista embebido
  artist: {
    name: String,
    email: String,
    bio: String
  }
});
```

**Pros**: Una sola consulta obtiene todo.
**Contras**: Datos duplicados, lÃ­mite 16MB por documento.

### 7.2 Referencias (Population)

Almacenar IDs y usar `populate()` para obtener datos relacionados.

```javascript
// src/models/track.model.js
import mongoose from 'mongoose';

const trackSchema = new mongoose.Schema({
  title: {
    type: String,
    required: true
  },
  duration: {
    type: Number,
    required: true
  },
  // Referencia a User
  artist: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'User',
    required: true
  },
  // Array de referencias
  collaborators: [{
    type: mongoose.Schema.Types.ObjectId,
    ref: 'User'
  }],
  genres: [String],
  plays: {
    type: Number,
    default: 0
  }
}, {
  timestamps: true,
  versionKey: false
});

const Track = mongoose.model('Track', trackSchema);
export default Track;
```

### 7.3 Uso de populate()

```javascript
// Obtener tracks con datos del artista
const tracks = await Track.find()
  .populate('artist', 'name email')      // Solo name y email
  .populate('collaborators', 'name');

// Populate anidado
const track = await Track.findById(id)
  .populate({
    path: 'artist',
    select: 'name email avatar',
    match: { isActive: true }            // Filtrar relacionados
  });

// Populate despuÃ©s de crear
const track = await Track.create(data);
await track.populate('artist', 'name email');
```

### 7.4 Â¿CuÃ¡ndo usar cada estrategia?

| Embedding | Referencias |
|-----------|-------------|
| Datos pequeÃ±os y estÃ¡ticos | Datos grandes o dinÃ¡micos |
| RelaciÃ³n 1:1 o 1:pocos | RelaciÃ³n 1:muchos o N:M |
| Siempre se leen juntos | Se leen independientemente |
| No crece indefinidamente | Documento crece mucho |

---

## 8. Subida de Archivos con Multer

> ğŸ“‚ **CÃ³digo de ejemplo**: [`codigo/T5/src/utils/handleStorage.js`](../codigo/T5/src/utils/handleStorage.js), [`codigo/T5/src/models/storage.model.js`](../codigo/T5/src/models/storage.model.js) y [`codigo/T5/src/controllers/storage.controller.js`](../codigo/T5/src/controllers/storage.controller.js)

Multer es el middleware estÃ¡ndar para manejar `multipart/form-data` (subida de archivos).

### 8.1 InstalaciÃ³n

```bash
npm install multer
```

### 8.2 ConfiguraciÃ³n

```javascript
// src/utils/handleStorage.js
import multer from 'multer';
import { extname, join } from 'node:path';

// Node.js 20.11+ - forma moderna
const __dirname = import.meta.dirname;

// ConfiguraciÃ³n de almacenamiento
const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    const uploadPath = join(__dirname, '../../storage');
    cb(null, uploadPath);
  },
  filename: (req, file, cb) => {
    const uniqueSuffix = `${Date.now()}-${Math.round(Math.random() * 1E9)}`;
    const ext = extname(file.originalname).toLowerCase();
    cb(null, `${file.fieldname}-${uniqueSuffix}${ext}`);
  }
});

// Filtro de tipos de archivo
const fileFilter = (req, file, cb) => {
  const allowedMimes = [
    'image/jpeg',
    'image/png',
    'image/gif',
    'image/webp',
    'audio/mpeg',
    'audio/wav',
    'application/pdf'
  ];
  
  if (allowedMimes.includes(file.mimetype)) {
    cb(null, true);
  } else {
    cb(new Error('Tipo de archivo no permitido'), false);
  }
};

// Middleware de upload
const uploadMiddleware = multer({
  storage,
  fileFilter,
  limits: {
    fileSize: 10 * 1024 * 1024,  // 10MB
    files: 5                      // MÃ¡ximo 5 archivos
  }
});

export default uploadMiddleware;
```

### 8.3 Modelo de Storage

```javascript
// src/models/storage.model.js
import mongoose from 'mongoose';

const storageSchema = new mongoose.Schema({
  filename: {
    type: String,
    required: true
  },
  originalName: String,
  url: {
    type: String,
    required: true
  },
  mimetype: {
    type: String,
    required: true
  },
  size: {
    type: Number,
    required: true
  },
  uploadedBy: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'User'
  }
}, {
  timestamps: true,
  versionKey: false
});

const Storage = mongoose.model('Storage', storageSchema);
export default Storage;
```

### 8.4 Rutas y Controlador

```javascript
// src/routes/storage.routes.js
import { Router } from 'express';
import uploadMiddleware from '../utils/handleStorage.js';
import { uploadFile, getFiles, deleteFile } from '../controllers/storage.controller.js';

const router = Router();

router.get('/', getFiles);
router.post('/', uploadMiddleware.single('file'), uploadFile);
router.delete('/:id', deleteFile);

export default router;
```

```javascript
// src/controllers/storage.controller.js
import Storage from '../models/storage.model.js';
import { unlink } from 'node:fs/promises';
import { join } from 'node:path';

const PUBLIC_URL = process.env.PUBLIC_URL || 'http://localhost:3000';

// POST /api/storage
export const uploadFile = async (req, res) => {
  if (!req.file) {
    return res.status(400).json({ error: 'No se subiÃ³ ningÃºn archivo' });
  }
  
  const { filename, originalname, mimetype, size } = req.file;
  
  const fileData = await Storage.create({
    filename,
    originalName: originalname,
    url: `${PUBLIC_URL}/uploads/${filename}`,
    mimetype,
    size
  });
  
  res.status(201).json({ data: fileData });
};

// GET /api/storage
export const getFiles = async (req, res) => {
  const files = await Storage.find().sort({ createdAt: -1 });
  res.json({ data: files });
};

// DELETE /api/storage/:id
export const deleteFile = async (req, res) => {
  const file = await Storage.findById(req.params.id);
  
  if (!file) {
    return res.status(404).json({ error: 'Archivo no encontrado' });
  }
  
  // Eliminar archivo fÃ­sico
  try {
    const filePath = join(process.cwd(), 'storage', file.filename);
    await unlink(filePath);
  } catch (err) {
    console.warn('Archivo fÃ­sico no encontrado');
  }
  
  await Storage.findByIdAndDelete(req.params.id);
  res.status(204).send();
};
```

---

## 9. Middleware de Errores

> ğŸ“‚ **CÃ³digo de ejemplo**: [`codigo/T5/src/middleware/error.middleware.js`](../codigo/T5/src/middleware/error.middleware.js) y [`codigo/T5/src/utils/handleError.js`](../codigo/T5/src/utils/handleError.js)

### 9.1 Manejo Global de Errores

```javascript
// src/middleware/error.middleware.js
import mongoose from 'mongoose';

export const notFound = (req, res, next) => {
  res.status(404).json({
    error: true,
    message: `Ruta no encontrada: ${req.method} ${req.originalUrl}`
  });
};

export const errorHandler = (err, req, res, next) => {
  console.error('âŒ Error:', err.message);
  
  // Error de validaciÃ³n de Mongoose
  if (err instanceof mongoose.Error.ValidationError) {
    const messages = Object.values(err.errors).map(e => e.message);
    return res.status(400).json({
      error: true,
      message: 'Error de validaciÃ³n',
      details: messages
    });
  }
  
  // Error de Cast (ID invÃ¡lido)
  if (err instanceof mongoose.Error.CastError) {
    return res.status(400).json({
      error: true,
      message: `Valor invÃ¡lido para '${err.path}'`
    });
  }
  
  // Error de duplicado
  if (err.code === 11000) {
    const field = Object.keys(err.keyValue)[0];
    return res.status(409).json({
      error: true,
      message: `Ya existe un registro con ese '${field}'`
    });
  }
  
  // Error de Multer
  if (err.code === 'LIMIT_FILE_SIZE') {
    return res.status(400).json({
      error: true,
      message: 'El archivo excede el tamaÃ±o mÃ¡ximo (10MB)'
    });
  }
  
  // Error genÃ©rico
  res.status(err.status || 500).json({
    error: true,
    message: err.message || 'Error interno del servidor'
  });
};
```

### 9.2 Utilidad de Errores

```javascript
// src/utils/handleError.js
export const handleHttpError = (res, message = 'Error interno', code = 500) => {
  res.status(code).json({
    error: true,
    message
  });
};

export class AppError extends Error {
  constructor(message, statusCode = 500) {
    super(message);
    this.statusCode = statusCode;
    this.status = `${statusCode}`.startsWith('4') ? 'fail' : 'error';
  }
}
```

---

## 10. ValidaciÃ³n de ObjectId

> ğŸ“‚ **CÃ³digo de ejemplo**: [`codigo/T5/src/middleware/validate.middleware.js`](../codigo/T5/src/middleware/validate.middleware.js)

```javascript
// src/middleware/validate.middleware.js
import mongoose from 'mongoose';

export const validate = (schema) => (req, res, next) => {
  try {
    schema.parse({
      body: req.body,
      query: req.query,
      params: req.params
    });
    next();
  } catch (error) {
    const errors = error.errors.map(e => ({
      field: e.path.join('.'),
      message: e.message
    }));
    
    res.status(400).json({
      error: true,
      message: 'Error de validaciÃ³n',
      details: errors
    });
  }
};

export const validateObjectId = (paramName = 'id') => (req, res, next) => {
  const id = req.params[paramName];
  
  if (!mongoose.Types.ObjectId.isValid(id)) {
    return res.status(400).json({
      error: true,
      message: `'${paramName}' no es un ID vÃ¡lido`
    });
  }
  
  next();
};
```

---

## 11. Ejercicios PrÃ¡cticos

### Ejercicio 1: API de Biblioteca

Crea una API para gestionar una biblioteca:

**Modelos:**

- `Author`: name, nationality, birthDate, bio
- `Book`: title, isbn (Ãºnico), author (ref), genre (enum), publishedYear, pages, available

**Endpoints:**

- CRUD completo para Author y Book
- `GET /api/books?genre=fiction&available=true`
- `GET /api/authors/:id/books`

### Ejercicio 2: Sistema de Tareas

Crea una API de tareas:

**Modelo Task:**

- title (requerido)
- description
- status (enum: pending, in_progress, completed)
- priority (enum: low, medium, high)
- dueDate
- assignedTo (ref a User)
- createdBy (ref a User)
- tags (array de strings)

**Endpoints:**

- CRUD de tareas
- Filtrar por status, priority, assignedTo
- Ordenar por dueDate, priority

### Ejercicio 3: GalerÃ­a de ImÃ¡genes

Extiende el storage para crear Ã¡lbumes:

**Modelo Album:**

- name (requerido)
- description
- coverImage (ref a Storage)
- images (array de refs a Storage)
- isPublic (default false)
- owner (ref a User)

**Endpoints:**

- CRUD de Ã¡lbumes
- `POST /api/albums/:id/images` - Agregar imagen
- `DELETE /api/albums/:id/images/:imageId` - Quitar imagen
- `GET /api/albums/public` - Ãlbumes pÃºblicos

---

## Ejercicio del Curso

Para poner en prÃ¡ctica los conceptos de este tema, realiza el siguiente ejercicio:

### ğŸ¬ BlockBuster API

Un millonario excÃ©ntrico quiere recrear la experiencia de los videoclubs de los 90s con una API REST moderna.

**UbicaciÃ³n:** `BlackBoard - Ejercicios de clase 26 / Ejercicio del Tema T5`

---

## Resumen

| Concepto | DescripciÃ³n |
|----------|-------------|
| MVC | PatrÃ³n de arquitectura: Model, View, Controller |
| MongoDB | Base de datos NoSQL orientada a documentos |
| MongoDB Atlas | Servicio cloud de MongoDB |
| Mongoose | ODM para modelar datos de MongoDB |
| Schema | Define estructura y validaciÃ³n de documentos |
| populate() | Obtiene datos de documentos referenciados |
| Multer | Middleware para subida de archivos |
| `--env-file` | Carga variables de entorno nativas en Node.js 22+ |

---

## Recursos Adicionales

- [MongoDB Manual](https://www.mongodb.com/docs/manual/)
- [Mongoose Documentation](https://mongoosejs.com/docs/)
- [MongoDB Atlas](https://www.mongodb.com/atlas)
- [Multer](https://github.com/expressjs/multer)
- [Zod](https://zod.dev/)

### PrÃ³ximo tema

En el **Tema 6 - ValidaciÃ³n Avanzada y Manejo de Errores** veremos:
- ValidaciÃ³n avanzada con Zod (refine, transform)
- Soft delete (borrado lÃ³gico)
- Plugins de Mongoose reutilizables
- Clase AppError con factory methods
- SanitizaciÃ³n contra inyecciÃ³n NoSQL

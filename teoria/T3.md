# Tema 3: HTTP y Enrutamiento

## √çndice

1. [Modelo Cliente-Servidor](#1-modelo-cliente-servidor)
2. [Protocolo HTTP](#2-protocolo-http)
3. [Versiones de HTTP](#3-versiones-de-http)
4. [Crear un Servidor HTTP con Node.js](#4-crear-un-servidor-http-con-nodejs)
5. [Objetos Request y Response](#5-objetos-request-y-response)
6. [Estructura de URLs](#6-estructura-de-urls)
7. [Enrutamiento (Routing)](#7-enrutamiento-routing)
8. [Cliente HTTP con fetch Nativo](#8-cliente-http-con-fetch-nativo)
9. [CORS: Cross-Origin Resource Sharing](#9-cors-cross-origin-resource-sharing)
10. [Herramientas para Probar APIs](#10-herramientas-para-probar-apis)
11. [Ejercicios Pr√°cticos](#11-ejercicios-pr√°cticos)

---

## 1. Modelo Cliente-Servidor

El modelo cliente-servidor es la arquitectura fundamental de Internet para acceder a recursos e informaci√≥n.

### Componentes

**Cliente**: Aplicaci√≥n que realiza solicitudes a un servidor. Puede ser un navegador web, una aplicaci√≥n m√≥vil, un script o cualquier programa que consuma servicios.

**Servidor**: Programa que se ejecuta en una m√°quina (f√≠sica o en la nube) para ofrecer servicios al cliente. Procesa solicitudes y env√≠a respuestas.

### Comunicaci√≥n

El cliente y el servidor se comunican mediante **protocolos** que definen el formato de los mensajes. El protocolo m√°s usado en la web es **HTTP** (Hypertext Transfer Protocol).

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         Solicitud HTTP          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         ‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫ ‚îÇ         ‚îÇ
‚îÇ Cliente ‚îÇ                                 ‚îÇ Servidor‚îÇ
‚îÇ         ‚îÇ  ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚îÇ         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         Respuesta HTTP          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Protocolo**: Conjunto de reglas que permiten transmitir informaci√≥n entre dispositivos de una red de forma estandarizada.

---

## 2. Protocolo HTTP

### 2.1 Solicitudes HTTP (Request)

Una solicitud HTTP es el mensaje que env√≠a el cliente al servidor para pedir informaci√≥n o desencadenar una acci√≥n.

**Componentes de una solicitud:**

| Componente | Descripci√≥n |
|------------|-------------|
| **M√©todo** | Verbo que indica la acci√≥n (GET, POST, PUT, DELETE, PATCH) |
| **URL/Path** | Direcci√≥n del recurso solicitado |
| **Versi√≥n HTTP** | HTTP/1.1, HTTP/2, HTTP/3 |
| **Headers** | Metadatos adicionales sobre la solicitud |
| **Body** | Datos enviados al servidor (opcional, usado en POST/PUT/PATCH) |

### 2.2 M√©todos HTTP

Los m√©todos HTTP indican la intenci√≥n de la solicitud:

| M√©todo | Prop√≥sito | ¬øTiene Body? | Idempotente |
|--------|-----------|--------------|-------------|
| **GET** | Obtener un recurso | No | S√≠ |
| **POST** | Crear un recurso nuevo | S√≠ | No |
| **PUT** | Reemplazar un recurso completo | S√≠ | S√≠ |
| **PATCH** | Modificar parcialmente un recurso | S√≠ | No |
| **DELETE** | Eliminar un recurso | Opcional | S√≠ |

> **Idempotente**: Una operaci√≥n es idempotente si ejecutarla m√∫ltiples veces produce el mismo resultado que ejecutarla una vez.

### 2.3 Respuestas HTTP (Response)

Una respuesta HTTP es el mensaje que env√≠a el servidor al cliente como resultado de una solicitud.

**Componentes de una respuesta:**

| Componente | Descripci√≥n |
|------------|-------------|
| **C√≥digo de estado** | N√∫mero que indica el resultado (200, 404, 500...) |
| **Texto de estado** | Descripci√≥n del c√≥digo (OK, Not Found...) |
| **Headers** | Metadatos de la respuesta |
| **Body** | Datos devueltos (HTML, JSON, imagen...) |

### 2.4 C√≥digos de Estado HTTP

Los c√≥digos de estado informan al cliente sobre el resultado de su solicitud:

| Rango | Categor√≠a | Ejemplos |
|-------|-----------|----------|
| **1xx** | Informativos | 100 Continue |
| **2xx** | √âxito | 200 OK, 201 Created, 204 No Content |
| **3xx** | Redirecci√≥n | 301 Moved Permanently, 304 Not Modified |
| **4xx** | Error del cliente | 400 Bad Request, 401 Unauthorized, 404 Not Found |
| **5xx** | Error del servidor | 500 Internal Server Error, 503 Service Unavailable |

**C√≥digos m√°s comunes:**

```javascript
// √âxito
200  // OK - Solicitud exitosa
201  // Created - Recurso creado (respuesta a POST)
204  // No Content - √âxito sin contenido en respuesta

// Errores del cliente
400  // Bad Request - Solicitud mal formada
401  // Unauthorized - No autenticado
403  // Forbidden - Autenticado pero sin permisos
404  // Not Found - Recurso no encontrado
422  // Unprocessable Entity - Validaci√≥n fallida

// Errores del servidor
500  // Internal Server Error - Error gen√©rico del servidor
503  // Service Unavailable - Servidor no disponible
```

üìö Referencia completa: [MDN HTTP Status Codes](https://developer.mozilla.org/es/docs/Web/HTTP/Status)

---

## 3. Versiones de HTTP

### HTTP/1.1 (1997)

- Una conexi√≥n TCP por solicitud (o keep-alive limitado)
- Cabeceras en texto plano
- Bloqueo head-of-line
- Sigue siendo ampliamente usado

### HTTP/2 (2015)

- Multiplexaci√≥n: m√∫ltiples solicitudes en una conexi√≥n
- Compresi√≥n de cabeceras (HPACK)
- Server Push (env√≠o proactivo de recursos)
- Binario en lugar de texto
- **Estable en Node.js** mediante el m√≥dulo `node:http2`

### HTTP/3 (2022)

- Basado en QUIC (UDP en lugar de TCP)
- Elimina el bloqueo head-of-line a nivel de transporte
- Conexiones m√°s r√°pidas (0-RTT)
- **Experimental en Node.js** - usar proxy reverso (Caddy, NGINX) para producci√≥n

```javascript
// HTTP/2 en Node.js (requiere certificados SSL)
import { createSecureServer } from 'node:http2';
import { readFileSync } from 'node:fs';

const server = createSecureServer({
  key: readFileSync('server.key'),
  cert: readFileSync('server.cert'),
  allowHTTP1: true  // Compatibilidad con HTTP/1.1
});

server.on('stream', (stream, headers) => {
  stream.respond({
    'content-type': 'text/html',
    ':status': 200
  });
  stream.end('<h1>Hello HTTP/2</h1>');
});

server.listen(8443);
```

> ‚ö†Ô∏è **Nota**: Express no soporta HTTP/2 nativamente. Para HTTP/2, considera Fastify o usa un proxy reverso.

---

## 4. Crear un Servidor HTTP con Node.js

### 4.1 M√≥dulo `node:http`

> üìÇ **C√≥digo de ejemplo**: [`codigo/T3/src/01-basic-server.js`](../codigo/T3/src/01-basic-server.js)

Node.js incluye el m√≥dulo `node:http` para crear servidores HTTP sin dependencias externas.

```javascript
// server.js
import { createServer } from 'node:http';

const server = createServer((req, res) => {
  // req: objeto Request con informaci√≥n de la solicitud
  // res: objeto Response para enviar la respuesta
  
  res.writeHead(200, { 'Content-Type': 'text/plain' });
  res.end('¬°Hola desde Node.js!');
});

const PORT = 3000;

server.listen(PORT, () => {
  console.log(`Servidor escuchando en http://localhost:${PORT}`);
});
```

### 4.2 Ejecutar el Servidor

**Modo tradicional:**
```bash
node server.js
```

**Con reinicio autom√°tico (Node.js 22+):**
```bash
node --watch server.js
```

> üí° **Node.js 22+** incluye `--watch` de forma nativa, eliminando la necesidad de nodemon en la mayor√≠a de casos.

**Opciones de --watch:**
```bash
# Vigilar solo ciertos directorios
node --watch-path=./src server.js

# Combinar con variables de entorno
node --watch --env-file=.env server.js
```

### 4.3 Puerto y Localhost

**Puerto**: Ubicaci√≥n virtual del sistema operativo donde una aplicaci√≥n escucha conexiones. Los puertos van de 0 a 65535.

- Puertos 0-1023: Reservados (80 HTTP, 443 HTTPS, 22 SSH)
- Puertos 1024-49151: Registrados para aplicaciones conocidas
- Puertos 49152-65535: Din√°micos/privados

**Localhost**: Nombre que referencia a tu propia m√°quina (IP 127.0.0.1).

```
http://localhost:3000/api/users
   ‚îÇ        ‚îÇ     ‚îÇ      ‚îÇ
   ‚îÇ        ‚îÇ     ‚îÇ      ‚îî‚îÄ‚îÄ Path
   ‚îÇ        ‚îÇ     ‚îî‚îÄ‚îÄ Puerto
   ‚îÇ        ‚îî‚îÄ‚îÄ Host (tu m√°quina)
   ‚îî‚îÄ‚îÄ Protocolo
```

---

## 5. Objetos Request y Response

### 5.1 Request (req)

Propiedades principales del objeto `req`:

```javascript
createServer((req, res) => {
  console.log(req.method);     // GET, POST, PUT, DELETE...
  console.log(req.url);        // /api/users?name=Juan
  console.log(req.headers);    // { 'content-type': 'application/json', ... }
  
  // Headers espec√≠ficos
  console.log(req.headers['content-type']);
  console.log(req.headers['authorization']);
});
```

### 5.2 Response (res)

M√©todos principales del objeto `res`:

```javascript
createServer((req, res) => {
  // Establecer c√≥digo de estado
  res.statusCode = 200;
  
  // Establecer headers
  res.setHeader('Content-Type', 'application/json');
  res.setHeader('X-Custom-Header', 'valor');
  
  // O usar writeHead para ambos
  res.writeHead(200, {
    'Content-Type': 'application/json',
    'Cache-Control': 'no-cache'
  });
  
  // Enviar respuesta y cerrar conexi√≥n
  res.end(JSON.stringify({ mensaje: 'Hola' }));
});
```

### 5.3 Leer el Body de una Solicitud

El body llega en chunks (trozos) que debemos concatenar:

```javascript
import { createServer } from 'node:http';

const server = createServer((req, res) => {
  if (req.method === 'POST') {
    let body = '';
    
    // Los datos llegan en eventos 'data'
    req.on('data', chunk => {
      body += chunk.toString();
    });
    
    // Cuando termina, procesamos
    req.on('end', () => {
      try {
        const data = JSON.parse(body);
        console.log('Datos recibidos:', data);
        
        res.writeHead(201, { 'Content-Type': 'application/json' });
        res.end(JSON.stringify({ recibido: data }));
      } catch (error) {
        res.writeHead(400, { 'Content-Type': 'application/json' });
        res.end(JSON.stringify({ error: 'JSON inv√°lido' }));
      }
    });
  }
});
```

---

## 6. Estructura de URLs

### 6.1 Anatom√≠a de una URL

```
https://www.ejemplo.com:8080/api/users/123?active=true&sort=name#section1
  ‚îÇ         ‚îÇ          ‚îÇ         ‚îÇ      ‚îÇ              ‚îÇ           ‚îÇ
  ‚îÇ         ‚îÇ          ‚îÇ         ‚îÇ      ‚îÇ              ‚îÇ           ‚îî‚îÄ‚îÄ Fragment
  ‚îÇ         ‚îÇ          ‚îÇ         ‚îÇ      ‚îÇ              ‚îî‚îÄ‚îÄ Query String
  ‚îÇ         ‚îÇ          ‚îÇ         ‚îÇ      ‚îî‚îÄ‚îÄ Path Parameters
  ‚îÇ         ‚îÇ          ‚îÇ         ‚îî‚îÄ‚îÄ Path
  ‚îÇ         ‚îÇ          ‚îî‚îÄ‚îÄ Puerto (opcional)
  ‚îÇ         ‚îî‚îÄ‚îÄ Dominio (host)
  ‚îî‚îÄ‚îÄ Protocolo (scheme)
```

### 6.2 Tipos de Par√°metros

**Path Parameters** (Par√°metros de ruta):
- Forman parte del path de la URL
- Identifican recursos espec√≠ficos
- Ejemplo: `/users/123` donde `123` es el ID del usuario

**Query Parameters** (Par√°metros de consulta):
- Van despu√©s del `?`
- Se usan para filtrar, ordenar, paginar
- Formato: `?clave=valor&clave2=valor2`
- Ejemplo: `/users?active=true&sort=name`

### 6.3 M√≥dulo URL en Node.js

```javascript
// Parsear URL completa
const miURL = new URL('https://ejemplo.com/cursos/web?nivel=basico&orden=vistas');

console.log(miURL.hostname);     // ejemplo.com
console.log(miURL.pathname);     // /cursos/web
console.log(miURL.search);       // ?nivel=basico&orden=vistas
console.log(miURL.searchParams); // URLSearchParams objeto

// Obtener par√°metros query
console.log(miURL.searchParams.get('nivel'));  // basico
console.log(miURL.searchParams.get('orden'));  // vistas
console.log(miURL.searchParams.has('orden'));  // true

// Iterar sobre todos los par√°metros
for (const [key, value] of miURL.searchParams) {
  console.log(`${key}: ${value}`);
}
```

**Parsear URL relativa de una request:**

```javascript
createServer((req, res) => {
  // req.url solo contiene path + query, no el host
  // Necesitamos construir URL completa
  const url = new URL(req.url, `http://${req.headers.host}`);
  
  console.log(url.pathname);              // /api/cursos
  console.log(url.searchParams.get('q')); // valor del param 'q'
});
```

---

## 7. Enrutamiento (Routing)

> üìÇ **C√≥digo de ejemplo**: [`codigo/T3/src/02-routing.js`](../codigo/T3/src/02-routing.js)

El enrutamiento consiste en dirigir las solicitudes a diferentes manejadores seg√∫n el m√©todo HTTP y el path solicitado.

### 7.1 Routing B√°sico

```javascript
import { createServer } from 'node:http';

const server = createServer((req, res) => {
  const { method, url } = req;
  
  // Parsear URL
  const parsedUrl = new URL(url, `http://${req.headers.host}`);
  const path = parsedUrl.pathname;
  
  // Enrutamiento b√°sico
  if (method === 'GET' && path === '/') {
    res.writeHead(200, { 'Content-Type': 'text/plain' });
    res.end('P√°gina principal');
    
  } else if (method === 'GET' && path === '/api/cursos') {
    res.writeHead(200, { 'Content-Type': 'application/json' });
    res.end(JSON.stringify({ cursos: [] }));
    
  } else {
    res.writeHead(404, { 'Content-Type': 'application/json' });
    res.end(JSON.stringify({ error: 'Ruta no encontrada' }));
  }
});

server.listen(3000);
```

### 7.2 Routing con Par√°metros de Ruta

```javascript
// Funci√≥n helper para extraer par√°metros de ruta
function matchRoute(pattern, path) {
  const patternParts = pattern.split('/');
  const pathParts = path.split('/');
  
  if (patternParts.length !== pathParts.length) return null;
  
  const params = {};
  
  for (let i = 0; i < patternParts.length; i++) {
    if (patternParts[i].startsWith(':')) {
      // Es un par√°metro
      const paramName = patternParts[i].slice(1);
      params[paramName] = pathParts[i];
    } else if (patternParts[i] !== pathParts[i]) {
      // No coincide
      return null;
    }
  }
  
  return params;
}

// Uso en el servidor
const server = createServer((req, res) => {
  const url = new URL(req.url, `http://${req.headers.host}`);
  const path = url.pathname;
  
  // GET /api/cursos/:id
  const cursoParams = matchRoute('/api/cursos/:id', path);
  if (req.method === 'GET' && cursoParams) {
    const { id } = cursoParams;
    res.writeHead(200, { 'Content-Type': 'application/json' });
    res.end(JSON.stringify({ curso: { id } }));
    return;
  }
  
  // GET /api/cursos/:categoria/:id
  const detailParams = matchRoute('/api/cursos/:categoria/:id', path);
  if (req.method === 'GET' && detailParams) {
    const { categoria, id } = detailParams;
    res.writeHead(200, { 'Content-Type': 'application/json' });
    res.end(JSON.stringify({ categoria, id }));
    return;
  }
  
  // 404
  res.writeHead(404);
  res.end('Not Found');
});
```

### 7.3 Router Modular

Para organizar mejor el c√≥digo, podemos crear un sistema de rutas modular:

```javascript
// router.js
export class Router {
  constructor() {
    this.routes = {
      GET: [],
      POST: [],
      PUT: [],
      PATCH: [],
      DELETE: []
    };
  }
  
  addRoute(method, path, handler) {
    this.routes[method].push({ path, handler });
  }
  
  get(path, handler) {
    this.addRoute('GET', path, handler);
  }
  
  post(path, handler) {
    this.addRoute('POST', path, handler);
  }
  
  put(path, handler) {
    this.addRoute('PUT', path, handler);
  }
  
  delete(path, handler) {
    this.addRoute('DELETE', path, handler);
  }
  
  resolve(method, url) {
    const parsedUrl = new URL(url, 'http://localhost');
    const path = parsedUrl.pathname;
    const query = Object.fromEntries(parsedUrl.searchParams);
    
    const routes = this.routes[method] || [];
    
    for (const route of routes) {
      const params = this.matchPath(route.path, path);
      if (params !== null) {
        return { handler: route.handler, params, query };
      }
    }
    
    return null;
  }
  
  matchPath(pattern, path) {
    const patternParts = pattern.split('/').filter(Boolean);
    const pathParts = path.split('/').filter(Boolean);
    
    if (patternParts.length !== pathParts.length) return null;
    
    const params = {};
    
    for (let i = 0; i < patternParts.length; i++) {
      if (patternParts[i].startsWith(':')) {
        params[patternParts[i].slice(1)] = pathParts[i];
      } else if (patternParts[i] !== pathParts[i]) {
        return null;
      }
    }
    
    return params;
  }
}
```

**Uso del Router:**

```javascript
// app.js
import { createServer } from 'node:http';
import { Router } from './router.js';

const router = new Router();

// Definir rutas
router.get('/api/cursos', (req, res, { query }) => {
  res.writeHead(200, { 'Content-Type': 'application/json' });
  res.end(JSON.stringify({ cursos: [], filtros: query }));
});

router.get('/api/cursos/:id', (req, res, { params }) => {
  res.writeHead(200, { 'Content-Type': 'application/json' });
  res.end(JSON.stringify({ id: params.id }));
});

router.post('/api/cursos', async (req, res) => {
  const body = await getBody(req);
  res.writeHead(201, { 'Content-Type': 'application/json' });
  res.end(JSON.stringify({ creado: body }));
});

// Helper para leer body
function getBody(req) {
  return new Promise((resolve, reject) => {
    let body = '';
    req.on('data', chunk => body += chunk);
    req.on('end', () => {
      try {
        resolve(JSON.parse(body));
      } catch {
        resolve(body);
      }
    });
    req.on('error', reject);
  });
}

// Servidor
const server = createServer((req, res) => {
  const match = router.resolve(req.method, req.url);
  
  if (match) {
    match.handler(req, res, { params: match.params, query: match.query });
  } else {
    res.writeHead(404, { 'Content-Type': 'application/json' });
    res.end(JSON.stringify({ error: 'Ruta no encontrada' }));
  }
});

server.listen(3000, () => {
  console.log('Servidor en http://localhost:3000');
});
```

---

## 8. Cliente HTTP con fetch Nativo

> üìÇ **C√≥digo de ejemplo**: [`codigo/T3/src/03-fetch-client.js`](../codigo/T3/src/03-fetch-client.js)

Node.js 21+ incluye `fetch` de forma estable, eliminando la necesidad de librer√≠as como `node-fetch` o `axios` para casos b√°sicos.

### 8.1 Peticiones GET

```javascript
// GET simple
const response = await fetch('https://jsonplaceholder.typicode.com/users');
const users = await response.json();
console.log(users);

// GET con query params
const url = new URL('https://api.ejemplo.com/search');
url.searchParams.set('q', 'node');
url.searchParams.set('limit', '10');

const response = await fetch(url);
```

### 8.2 Peticiones POST

```javascript
const response = await fetch('https://api.ejemplo.com/users', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer token123'
  },
  body: JSON.stringify({
    name: 'Juan',
    email: 'juan@ejemplo.com'
  })
});

if (!response.ok) {
  throw new Error(`HTTP error: ${response.status}`);
}

const nuevoUsuario = await response.json();
```

### 8.3 Manejo de Errores

```javascript
async function fetchData(url) {
  try {
    const response = await fetch(url);
    
    if (!response.ok) {
      // 4xx o 5xx
      const errorBody = await response.text();
      throw new Error(`HTTP ${response.status}: ${errorBody}`);
    }
    
    return await response.json();
    
  } catch (error) {
    if (error.name === 'TypeError') {
      // Error de red (sin conexi√≥n, DNS, etc.)
      console.error('Error de red:', error.message);
    } else {
      console.error('Error:', error.message);
    }
    throw error;
  }
}
```

### 8.4 Timeout con AbortSignal

La forma m√°s simple de a√±adir timeout a fetch:

```javascript
// ‚úÖ Forma simple con AbortSignal.timeout()
const response = await fetch(url, {
  signal: AbortSignal.timeout(5000)  // 5 segundos
});
```

Para casos donde necesitas cancelaci√≥n manual adem√°s del timeout:

```javascript
// Cancelaci√≥n manual + timeout
const controller = new AbortController();

// Combinar se√±ales: timeout O cancelaci√≥n manual
const signal = AbortSignal.any([
  controller.signal,
  AbortSignal.timeout(5000)
]);

try {
  const response = await fetch(url, { signal });
  return await response.json();
} catch (error) {
  if (error.name === 'AbortError') {
    console.log('Cancelado por timeout o manualmente');
  }
  throw error;
}

// Bot√≥n de cancelar
botonCancelar.onclick = () => controller.abort();
```

---

## 9. CORS: Cross-Origin Resource Sharing

CORS es un mecanismo de seguridad del navegador que restringe las peticiones HTTP entre diferentes or√≠genes (dominios, protocolos o puertos).

### ¬øPor qu√© existe CORS?

Por defecto, los navegadores bloquean peticiones desde JavaScript a un dominio diferente al de la p√°gina actual (Same-Origin Policy). Esto previene ataques de sitios maliciosos.

```
P√°gina en: https://mi-app.com
Petici√≥n a: https://api.otro-dominio.com  ‚Üê Bloqueada por CORS
```

### Headers CORS

El servidor debe incluir headers espec√≠ficos para permitir peticiones cross-origin:

```javascript
// En tu servidor HTTP nativo
const server = createServer((req, res) => {
  // Headers CORS b√°sicos
  res.setHeader('Access-Control-Allow-Origin', '*');  // o dominio espec√≠fico
  res.setHeader('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization');

  // Preflight request (OPTIONS)
  if (req.method === 'OPTIONS') {
    res.writeHead(204);
    res.end();
    return;
  }

  // ... resto del c√≥digo
});
```

### Preflight Request

Para peticiones "complejas" (POST con JSON, headers custom, etc.), el navegador env√≠a primero una petici√≥n OPTIONS para verificar si el servidor permite la operaci√≥n:

```
1. Navegador ‚Üí OPTIONS /api/users (preflight)
2. Servidor ‚Üí 204 con headers CORS
3. Navegador ‚Üí POST /api/users (petici√≥n real)
4. Servidor ‚Üí 201 Created
```

> **Nota**: En desarrollo local (localhost), tambi√©n aplica CORS si los puertos son diferentes. En el **Tema 4** veremos c√≥mo configurar CORS f√°cilmente con Express y el middleware `cors`.

---

## 10. Herramientas para Probar APIs

### 10.1 REST Client (VS Code)

Extensi√≥n para VS Code que permite hacer peticiones HTTP desde archivos `.http` o `.rest`.

**Instalaci√≥n**: Buscar "REST Client" en extensiones de VS Code (autor: Huachao Mao)

**Crear archivo `api.http`:**

```http
### Variables
@baseUrl = http://localhost:3000/api
@token = Bearer eyJhbGciOiJIUzI1NiIs...

### GET todos los cursos
GET {{baseUrl}}/cursos HTTP/1.1

### GET curso por ID
GET {{baseUrl}}/cursos/1 HTTP/1.1

### GET con query params
GET {{baseUrl}}/cursos?categoria=programacion&nivel=basico HTTP/1.1

### POST crear curso
POST {{baseUrl}}/cursos HTTP/1.1
Content-Type: application/json
Authorization: {{token}}

{
  "titulo": "Node.js Avanzado",
  "categoria": "programacion",
  "nivel": "avanzado"
}

### PUT actualizar curso
PUT {{baseUrl}}/cursos/1 HTTP/1.1
Content-Type: application/json

{
  "titulo": "Node.js Actualizado",
  "categoria": "programacion",
  "nivel": "intermedio"
}

### DELETE eliminar curso
DELETE {{baseUrl}}/cursos/1 HTTP/1.1
```

Haz clic en "Send Request" sobre cada petici√≥n para ejecutarla.

### 10.2 Bruno

Cliente de APIs open-source, offline-first, que guarda las colecciones como archivos de texto en tu sistema de archivos (ideal para control de versiones con Git).

**Caracter√≠sticas:**
- Sin cuenta ni sincronizaci√≥n en la nube
- Colecciones en formato `.bru` (texto plano)
- Variables de entorno
- Scripts pre/post request
- Soporte para GraphQL

**Instalaci√≥n**: [usebruno.com](https://www.usebruno.com/)

### 10.3 Hoppscotch

Alternativa web a Postman, open-source y gratuita. Soporta HTTP, WebSocket, GraphQL, MQTT y m√°s.

**Caracter√≠sticas:**
- Interfaz web en [hoppscotch.io](https://hoppscotch.io/)
- Self-hosteable
- Colaboraci√≥n en tiempo real
- Historial de peticiones

### 10.4 Thunder Client

Extensi√≥n de VS Code similar a Postman pero integrada en el editor.

**Nota**: La versi√≥n gratuita ahora est√° limitada a uso no comercial. Para uso comercial se requiere licencia de pago.

### 10.5 cURL (L√≠nea de Comandos)

```bash
# GET
curl http://localhost:3000/api/cursos

# GET con headers
curl -H "Authorization: Bearer token123" http://localhost:3000/api/cursos

# POST con JSON
curl -X POST http://localhost:3000/api/cursos \
  -H "Content-Type: application/json" \
  -d '{"titulo": "Nuevo curso", "nivel": "basico"}'

# PUT
curl -X PUT http://localhost:3000/api/cursos/1 \
  -H "Content-Type: application/json" \
  -d '{"titulo": "Curso actualizado"}'

# DELETE
curl -X DELETE http://localhost:3000/api/cursos/1

# Ver headers de respuesta
curl -i http://localhost:3000/api/cursos

# Solo headers (HEAD)
curl -I http://localhost:3000/api/cursos
```

---

## 11. Ejercicios Pr√°cticos

### Ejercicio 1: Servidor B√°sico

Crea un servidor HTTP que responda a las siguientes rutas:
- `GET /` ‚Üí "Bienvenido a la API"
- `GET /health` ‚Üí `{ "status": "ok", "timestamp": "..." }`
- Cualquier otra ruta ‚Üí 404

### Ejercicio 2: API de Cursos

Implementa una API REST completa para gestionar cursos:

```
GET    /api/cursos              ‚Üí Lista todos los cursos
GET    /api/cursos/:id          ‚Üí Obtiene un curso por ID
GET    /api/cursos?nivel=basico ‚Üí Filtra cursos por nivel
POST   /api/cursos              ‚Üí Crea un nuevo curso
PUT    /api/cursos/:id          ‚Üí Actualiza un curso
DELETE /api/cursos/:id          ‚Üí Elimina un curso
```

Datos de ejemplo:
```javascript
const cursos = [
  { id: 1, titulo: 'JavaScript B√°sico', nivel: 'basico', vistas: 1500 },
  { id: 2, titulo: 'Node.js Intermedio', nivel: 'intermedio', vistas: 980 },
  { id: 3, titulo: 'Express Avanzado', nivel: 'avanzado', vistas: 750 }
];
```

### Ejercicio 3: Cliente HTTP

Usando `fetch` nativo, crea un script que:
1. Obtenga datos de `https://jsonplaceholder.typicode.com/posts`
2. Filtre los posts del usuario con ID 1
3. Cree un nuevo post con `POST`
4. Maneje errores correctamente

### Ejercicio 4: Query Parameters

Extiende la API de cursos para soportar:
- `?orden=vistas` ‚Üí Ordena por vistas (descendente)
- `?orden=titulo` ‚Üí Ordena alfab√©ticamente
- `?limit=5` ‚Üí Limita resultados
- `?offset=10` ‚Üí Paginaci√≥n

---

## Ejercicio del Curso

Para poner en pr√°ctica los conceptos de este tema, realiza el siguiente ejercicio:

### üîó URL Shortener Nativo

Crea un acortador de URLs usando solo el m√≥dulo `node:http`, sin Express ni otros frameworks.

**Ubicaci√≥n:** `ejercicios/T3/`

**Endpoints a implementar:**
| M√©todo | Ruta | Descripci√≥n |
|--------|------|-------------|
| POST | /shorten | Crea URL corta |
| GET | /:code | Redirige a URL original |
| GET | /stats/:code | Estad√≠sticas de la URL |
| GET | /api/urls | Lista todas las URLs |
| DELETE | /api/urls/:code | Elimina una URL |

**Conceptos a aplicar:**
- Servidor HTTP nativo sin frameworks
- Parseo de JSON del body
- Generaci√≥n de c√≥digos √∫nicos
- Redirecci√≥n con status 302
- Almacenamiento en memoria (Map)

```bash
cd ejercicios/T3
node src/server.js
```

Consulta el README del ejercicio para m√°s detalles.

---

## Resumen

| Concepto | Descripci√≥n |
|----------|-------------|
| HTTP | Protocolo de comunicaci√≥n cliente-servidor |
| Request | Solicitud del cliente (m√©todo, URL, headers, body) |
| Response | Respuesta del servidor (status, headers, body) |
| Routing | Dirigir solicitudes a manejadores espec√≠ficos |
| Path params | Par√°metros en la ruta (`/users/:id`) |
| Query params | Par√°metros de filtrado (`?key=value`) |
| `--watch` | Reinicio autom√°tico nativo en Node.js 22+ |
| `fetch` | Cliente HTTP nativo en Node.js 21+ |

---

## Recursos Adicionales

- [Documentaci√≥n HTTP - MDN](https://developer.mozilla.org/es/docs/Web/HTTP)
- [Node.js HTTP Module](https://nodejs.org/api/http.html)
- [Node.js URL Module](https://nodejs.org/api/url.html)
- [HTTP/2 en Node.js](https://nodejs.org/api/http2.html)
- [REST Client - VS Code](https://marketplace.visualstudio.com/items?itemName=humao.rest-client)
- [Bruno - API Client](https://www.usebruno.com/)

### Pr√≥ximo tema

En el **Tema 4 - Express** veremos:
- Framework Express 5 y su ecosistema
- Middleware y su cadena de ejecuci√≥n
- Router modular y organizaci√≥n de rutas
- Validaci√≥n con Zod
- Manejo centralizado de errores
